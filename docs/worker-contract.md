# Worker Contract

This document describes the contract that worker hosts (GitHub runners, self-hosted agents, or other orchestration systems) must follow to invoke the WordPress vulnerability scanner CLI reliably.

## Responsibilities

1. **Worker** executes the CLI binary, provides configuration (targets, credentials, scan parameters), and persists artifacts/logs.
2. **CLI** performs validation, runs `wpprobe`, and emits structured NDJSON events plus exit codes suitable for automation.

## Inputs

| Input | Source | Required | Notes |
| --- | --- | --- | --- |
| `targets` | `--targets`, `WORKER_TARGETS`, or config file | ✅ | File path or comma-separated URLs. CLI normalizes into a temp file. |
| `mode` | `--mode`, `WORKER_MODE`, config | ⛔ (default `hybrid`) | Accepted: `stealthy`, `bruteforce`, `hybrid`. |
| `threads` | `--threads`, `WORKER_THREADS`, config | ⛔ (default `10`) | Upper bound guarded to prevent runaway usage. |
| `output-dir` | `--output-dir`, `WORKER_OUTPUT_DIR` | ⛔ (default `./scan-results`) | Must be writable. CLI creates timestamped files. |
| `format` | `--format`, `WORKER_FORMAT` | ⛔ (default `json,csv`) | Determines artifacts generated by `scan`. |
| `config file` | `--config` (default `worker.config.yml`) | ⛔ | YAML with mirrors of the above keys. |

## Outputs

- Timestamped JSON and optional CSV files under `output-dir`.
- Structured NDJSON events on stdout for streaming to logs/queues. Each event includes `type`, `timestamp`, `targets`, `scanMode`, `stats`, and `path` fields.
- Exit codes (see below) conveying success/failure modes.

## Exit Codes

| Code | Meaning |
| --- | --- |
| `0` | Scan completed with no blocking errors. Vulnerabilities may still exist; refer to artifacts. |
| `1` | Invalid configuration (missing targets, unreadable file, invalid mode). |
| `2` | Runtime failure (wpprobe error, network failure, filesystem error). |
| `3` | Post-processing or report generation failure. |

Workers must treat non-zero codes as failed jobs.

## Environment Requirements

- OS: Linux amd64 or arm64 (statically linked binary works on both).
- Dependencies: `wpprobe` binary bundled in the CLI release; no external Go toolchain required.
- Network: HTTPS egress to target sites and Wordfence feed (for updates) unless operating offline with pre-fetched databases.
- Disk: Minimum 200 MB free for temp files and scan artifacts.

## Secrets & Sensitive Data

- Secrets (API tokens, authenticated endpoints) should be injected via environment variables and referenced in config files using `${VAR}` syntax; the CLI resolves and redacts them from logs.
- Targets with credentials must use HTTPS to avoid leaking tokens.

## Logging & Observability

- Stdout: NDJSON events for ingestion by log shippers.
- Stderr: Human-readable status lines prefixed with `[worker]` for quick diagnosis.
- Optional `--summary-file` for writing a condensed JSON summary for dashboards.

## Workflow Sequence

1. Worker downloads/extracts CLI release (`wp-worker-cli` binary plus checksum file).
2. Place or generate `worker.config.yml`/`targets.txt`.
3. Run `wp-worker-cli init` to validate environment and warm caches (optional but recommended).
4. Run `wp-worker-cli scan [flags]`.
5. Optionally run `wp-worker-cli report --input scan-results/<file.json>` to derive severity stats.
6. Upload artifacts/logs per platform conventions.

## Validation Rules

- At least one target must be provided; `init` fails with exit code 1 otherwise.
- `threads` must be between 1 and 64.
- `mode` must be one of the allowed values.
- `output-dir` must exist or be creatable by the current user.

## Future Extensions

- Differential scan inputs (baseline artifact references).
- Notification sinks (Slack/webhooks) configured via `notifications` block.
- Signed vulnerability feed cache distribution for air-gapped workers.
