name: WordPress Vulnerability Scan

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      urls:
        description: 'Comma-separated URLs to scan (overrides targets.txt)'
        required: false
        type: string
      scan_mode:
        description: 'Scan mode'
        required: false
        default: 'hybrid'
        type: choice
        options:
          - stealthy
          - bruteforce
          - hybrid

permissions:
  contents: write
  issues: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install wpprobe
        run: |
          go install github.com/Chocapikk/wpprobe@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Verify wpprobe installation
        run: wpprobe --version || echo "wpprobe installed successfully"

      - name: Update WPProbe vulnerability database
        run: wpprobe update-db

      - name: Prepare scan targets
        id: prepare
        run: |
          if [ -n "${{ github.event.inputs.urls }}" ]; then
            echo "${{ github.event.inputs.urls }}" | tr ',' '\n' > /tmp/targets.txt
          elif [ -f targets.txt ]; then
            cp targets.txt /tmp/targets.txt
          else
            echo "No targets specified. Please create targets.txt or provide URLs via workflow_dispatch."
            exit 1
          fi
          echo "Targets to scan:"
          cat /tmp/targets.txt

      - name: Run WordPress vulnerability scan
        run: |
          SCAN_MODE="${{ github.event.inputs.scan_mode || 'hybrid' }}"
          mkdir -p scan-results
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          echo "Running wpprobe scan in $SCAN_MODE mode..."
          # wpprobe auto-detects format from file extension (.json or .csv)
          wpprobe scan -f /tmp/targets.txt --mode "$SCAN_MODE" -o "scan-results/scan_${TIMESTAMP}.json" -t 10 || true

          # Convert JSON to CSV for easier viewing if jq is available
          if command -v jq &> /dev/null && [ -f "scan-results/scan_${TIMESTAMP}.json" ]; then
            echo "Note: JSON output generated. CSV conversion would require additional processing."
            echo "Generating both formats by running scan twice to ensure compatibility."
            wpprobe scan -f /tmp/targets.txt --mode "$SCAN_MODE" -o "scan-results/scan_${TIMESTAMP}.csv" -t 10 || true
          fi

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results-${{ github.run_number }}
          path: scan-results/
          retention-days: 90

      - name: Check for vulnerabilities
        id: check_vulns
        run: |
          shopt -s nullglob
          json_files=(scan-results/*.json)
          if [ ${#json_files[@]} -gt 0 ]; then
            # Check if any vulnerabilities were found by looking for non-empty vulnerability arrays
            # This looks for patterns like "vulnerabilities":[{"cve": indicating actual vulnerabilities
            VULN_COUNT=$(grep -c '"vulnerabilities":\[{' "${json_files[@]}" 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT entries with potential vulnerabilities"
            echo "vuln_count=$VULN_COUNT" >> "$GITHUB_OUTPUT"

            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "âš ï¸ Vulnerabilities detected! Check the scan results artifact."
            fi
          fi

      - name: Create issue on vulnerabilities
        if: steps.check_vulns.outputs.vuln_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const scanFiles = fs.readdirSync('scan-results').filter(f => f.endsWith('.json'));

            let issueBody = '## WordPress Vulnerability Scan Results\n\n';
            issueBody += `**Scan Date:** ${new Date().toISOString()}\n`;
            issueBody += `**Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            issueBody += '### Summary\n\n';
            issueBody += 'Vulnerabilities were detected in the WordPress installations. ';
            issueBody += 'Please review the scan results artifact for detailed information.\n\n';
            issueBody += '### Action Required\n\n';
            issueBody += '1. Download the scan results artifact from the workflow run\n';
            issueBody += '2. Review identified vulnerabilities\n';
            issueBody += '3. Update affected plugins/themes\n';
            issueBody += '4. Re-run the scan to verify fixes\n\n';
            issueBody += '### Scan Results\n\n';
            issueBody += 'See attached artifacts in the [workflow run]';
            issueBody += `(${context.payload.repository.html_url}/actions/runs/${context.runId}).\n`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `WordPress Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['security', 'vulnerability-scan']
            });

      - name: Summary
        if: always()
        run: |
          {
            echo "### WordPress Vulnerability Scan Complete ðŸ”"
            echo ""
            echo "**Scan Mode:** ${{ github.event.inputs.scan_mode || 'hybrid' }}"
            echo "**Timestamp:** $(date -u)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          shopt -s nullglob
          csv_files=(scan-results/*.csv)
          if [ ${#csv_files[@]} -gt 0 ]; then
            {
              echo "Results have been saved and uploaded as artifacts."
              echo ""
              echo "Download the artifacts to view detailed scan results."
            } >> "$GITHUB_STEP_SUMMARY"
          fi